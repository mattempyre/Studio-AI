version: '3.8'

services:
  # Inngest Dev Server - Job queue orchestration
  # Ports can be customized via environment variables for worktree development:
  #   INNGEST_DEV_PORT=8211 BACKEND_PORT=3101 docker-compose up inngest
  inngest:
    image: inngest/inngest:latest
    ports:
      - "${INNGEST_DEV_PORT:-8288}:8288"
    command: inngest dev -u http://host.docker.internal:${PORT:-3001}/api/v1/inngest --no-poll
    environment:
      - INNGEST_LOG_LEVEL=info
    extra_hosts:
      - "host.docker.internal:host-gateway"
    healthcheck:
      test: ["CMD", "wget", "-q", "--spider", "http://localhost:8288/health"]
      interval: 10s
      timeout: 5s
      retries: 3

  # Whisper Transcription Service - Word-level timestamps for audio segmentation
  whisper:
    build: ./services/whisper
    ports:
      - "${WHISPER_PORT:-8005}:8005"
    volumes:
      - ./data/projects:/data/projects:ro  # Read-only access to audio files
    environment:
      - WHISPER_MODEL_SIZE=${WHISPER_MODEL_SIZE:-base}
      - WHISPER_DEVICE=${WHISPER_DEVICE:-cpu}
      - WHISPER_COMPUTE_TYPE=${WHISPER_COMPUTE_TYPE:-int8}
    healthcheck:
      test: ["CMD", "python", "-c", "import urllib.request; urllib.request.urlopen('http://localhost:8005/health')"]
      interval: 30s
      timeout: 10s
      start_period: 60s
      retries: 3

# Future services (to be added in later stories):
#
# Note: Chatterbox TTS is expected to be running externally on port 8004
# Configure CHATTERBOX_URL in .env.local if using a different address
#
#   comfyui:
#     image: comfyui:latest
#     volumes:
#       - ./models:/models
#       - ./workflows:/workflows
#     ports:
#       - "8188:8188"
#     deploy:
#       resources:
#         reservations:
#           devices:
#             - driver: nvidia
#               count: 1
#               capabilities: [gpu]
